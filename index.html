<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Styles -->
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
  <link rel="stylesheet" href="css/qgis2web.css">
  <link rel="stylesheet" href="css/fontawesome-all.min.css">
  <link rel="stylesheet" href="css/leaflet.photon.css">

  <title>Map with Sidebar & Layers Panel</title>

  <style>
    :root{
      --sidebar-w: 340px;
      --sidebar-bg: #ffffff;
      --sidebar-border: #e5e7eb;
    }

    html, body {
      margin: 0; height: 100%; width: 100%;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: #111827;
    }

    /* App layout */
    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: var(--sidebar-w);
      min-width: var(--sidebar-w);
      background: var(--sidebar-bg);
      border-right: 1px solid var(--sidebar-border);
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      z-index: 1000;
    }
    .sidebar-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--sidebar-border);
      background: #f9fafb;
      font-weight: 600;
      font-size: 15px;
    }
    .sidebar-content {
      padding: 12px 14px;
      overflow: hidden;          /* important for flex child scroll */
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;             /* enables inner scroll */
    }

    .panel {
      border: 1px solid var(--sidebar-border);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
    }
    .panel h3 { margin: 0 0 8px 0; font-size: 14px; }
    .muted { color: #6b7280; }

    /* Make the Layers panel stretch & scroll nicely */
    .panel--flex {
      display: flex; flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
    }
    #layersContainer {
      flex: 1 1 auto;
      min-height: 0;
      overflow: hidden;          /* delegate scroll to the list inside */
      padding: 6px;
      border: 1px solid var(--sidebar-border);
      border-radius: 8px;
      background: #fafafa;
    }

    /* Map area */
    #map { flex: 1 1 auto; height: 100%; width: 100%; }

    /* Make the Layers Tree behave like normal content */
    #layersContainer .leaflet-control { margin: 0; border: 0; box-shadow: none; width: 100%; }
    #layersContainer .leaflet-control-layers { position: static; width: 100%; height: 100%; }
    #layersContainer .leaflet-control-layers-expanded { padding: 0; margin: 0; border: 0; box-shadow: none; height: 100%; }
    #layersContainer .leaflet-control-layers-list {
      height: 100%; max-height: none; overflow-y: auto; padding: 4px;
    }
    #layersContainer .leaflet-control-layers-toggle { display: none; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="sidebar-header">Houses and Tourism Spots in Kinmen</div>
      <div class="sidebar-content">
        <div class="panel">
          <h3>About</h3>
          <p class="muted">Houses & tourism POIs with two heatmaps (OSM base).</p>
        </div>

        <!-- Layers panel (Leaflet control will be moved here) -->
        <div class="panel panel--flex">
          <h3>Layers</h3>
          <div id="layersContainer"></div>
        </div>

        <div class="panel">
          <h3>Legend</h3>
          <div style="display:flex;align-items:center;gap:8px;">
            <img src="legend/Centroids_House_1.png" alt="Centroids" />
            <small class="muted">Centroids_House</small>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
            <img src="legend/tourism_attraction_2.png" alt="Tourism" />
            <small class="muted">tourism_attraction</small>
          </div>
        </div>

        <!-- ✨ CHANGE: Downloads panel -->
        <div class="panel"><!-- ✨ CHANGE -->
          <h3>Downloads</h3><!-- ✨ CHANGE -->
          <ul style="margin:0; padding-left:1rem;"><!-- ✨ CHANGE -->
            <li><a href="#" onclick="downloadAll_Centroids(); return false;">Download GeoJSON: Centroids (all)</a></li><!-- ✨ CHANGE -->
            <li><a href="#" onclick="downloadAll_Tourism(); return false;">Download GeoJSON: Tourism (all)</a></li><!-- ✨ CHANGE -->
            <li><a href="#" onclick="downloadVisible_Both(); return false;">Download GeoJSON: In view (both)</a></li><!-- ✨ CHANGE -->
          </ul><!-- ✨ CHANGE -->
        </div><!-- ✨ CHANGE -->

      </div>
    </aside>

    <!-- Map -->
    <div id="map"></div>
  </div>

  <!-- Scripts -->
  <script src="js/qgis2web_expressions.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/L.Control.Layers.Tree.min.js"></script>
  <script src="js/leaflet.rotatedMarker.js"></script>
  <script src="js/leaflet.pattern.js"></script>
  <script src="js/leaflet-hash.js"></script>
  <script src="js/Autolinker.min.js"></script>
  <script src="js/rbush.min.js"></script>
  <script src="js/labelgun.min.js"></script>
  <script src="js/labels.js"></script>
  <script src="js/leaflet.photon.js"></script>

  <!-- Your data -->
  <script src="data/Centroids_House_1.js"></script>
  <script src="data/tourism_attraction_2.js"></script>

  <script>
    // Safety for photon code
    var obj2 = window.obj2 || {};
    var obj3 = window.obj3 || {};

    var highlightLayer;
    function highlightFeature(e) {
      highlightLayer = e.target;
      if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
        highlightLayer.setStyle({ color: '#ffff00' });
      } else {
        highlightLayer.setStyle({ fillColor: '#ffff00', fillOpacity: 1 });
      }
    }

    var map = L.map('map', {
      zoomControl:false, maxZoom:28, minZoom:1
    }).fitBounds([[24.308908686161143,118.16000087858514],[24.574140369915835,118.4950588627568]]);

    var hash = new L.Hash(map);
    map.attributionControl.setPrefix(
      '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
      '<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; ' +
      '<a href="https://qgis.org">QGIS</a>'
    );
    var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

    function removeEmptyRowsFromPopupContent(content, feature) {
      var tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      var rows = tempDiv.querySelectorAll('tr');
      for (var i = 0; i < rows.length; i++) {
        var td = rows[i].querySelector('td.visible-with-data');
        var key = td ? td.id : '';
        if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
          rows[i].parentNode.removeChild(rows[i]);
        }
      }
      return tempDiv.innerHTML;
    }
    function addClassToPopupIfMedia(content, popup) {
      var tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      if (tempDiv.querySelector('td img')) {
        popup._contentNode.classList.add('media');
        setTimeout(function(){ popup.update(); }, 10);
      } else {
        popup._contentNode.classList.remove('media');
      }
    }

    L.control.zoom({ position: 'topleft' }).addTo(map);
    var bounds_group = new L.featureGroup([]);
    function setBounds() {}

    // Basemap
    map.createPane('pane_OpenStreetMap_0');
    map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
    var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      pane: 'pane_OpenStreetMap_0',
      opacity: 1.0,
      attribution: '',
      minZoom: 1,
      maxZoom: 28,
      minNativeZoom: 0,
      maxNativeZoom: 19
    }).addTo(map);

    // Centroids_House
    function pop_Centroids_House_1(feature, layer) {
      layer.on({
        mouseout: function(e) {
          for (var i in e.target._eventParents) {
            if (typeof e.target._eventParents[i].resetStyle === 'function') {
              e.target._eventParents[i].resetStyle(e.target);
            }
          }
        },
        mouseover: highlightFeature,
      });
      var popupContent = '<table>\
          <tr><td colspan="2">' + (feature.properties['building'] ?? '') + '</td></tr>\
        </table>';
      var content = removeEmptyRowsFromPopupContent(popupContent, feature);
      layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
      layer.bindPopup(content, { maxHeight: 400 });
    }
    function style_Centroids_House_1_0() {
      return {
        pane: 'pane_Centroids_House_1',
        radius: 4.0,
        opacity: 1,
        color: 'rgba(35,35,35,1.0)',
        weight: 1,
        fill: true,
        fillOpacity: 1,
        fillColor: 'rgba(203,40,15,1.0)',
        interactive: true,
      }
    }
    map.createPane('pane_Centroids_House_1');
    map.getPane('pane_Centroids_House_1').style.zIndex = 401;
    map.getPane('pane_Centroids_House_1').style['mix-blend-mode'] = 'normal';
    var layer_Centroids_House_1 = new L.geoJson(json_Centroids_House_1, {
      attribution: '',
      interactive: true,
      dataVar: 'json_Centroids_House_1',
      layerName: 'layer_Centroids_House_1',
      pane: 'pane_Centroids_House_1',
      onEachFeature: pop_Centroids_House_1,
      pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, style_Centroids_House_1_0(feature));
      },
    }).addTo(map);
    bounds_group.addLayer(layer_Centroids_House_1);

    // tourism_attraction
    function pop_tourism_attraction_2(feature, layer) {
      layer.on({
        mouseout: function(e) {
          for (var i in e.target._eventParents) {
            if (typeof e.target._eventParents[i].resetStyle === 'function') {
              e.target._eventParents[i].resetStyle(e.target);
            }
          }
        },
        mouseover: highlightFeature,
      });
      var popupContent = '<table>\
          <tr><td colspan="2">' + (feature.properties['full_id'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['osm_id'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['osm_type'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['tourism'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['description'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['fee'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['mapillary'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['historic'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['operator'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['name:ja'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['alt_name'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['military'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['building'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['emergency'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['access'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['wikipedia:zh'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['wikipedia'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['website'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['phone'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['opening_hours'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['name:zh'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['name:en'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['addr:street'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['addr:province'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['addr:postcode'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['addr:housenumber'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['addr:district'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['addr:country'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['addr:city'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['wikidata'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['name'] ?? '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['man_made'] ?? '') + '</td></tr>\
        </table>';
      var content = removeEmptyRowsFromPopupContent(popupContent, feature);
      layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
      layer.bindPopup(content, { maxHeight: 400 });
    }
    function style_tourism_attraction_2_0() {
      return {
        pane: 'pane_tourism_attraction_2',
        radius: 4.0,
        opacity: 1,
        color: 'rgba(35,35,35,1.0)',
        weight: 1,
        fill: true,
        fillOpacity: 1,
        fillColor: 'rgba(51,160,44,1.0)',
        interactive: true,
      }
    }
    map.createPane('pane_tourism_attraction_2');
    map.getPane('pane_tourism_attraction_2').style.zIndex = 402;
    map.getPane('pane_tourism_attraction_2').style['mix-blend-mode'] = 'normal';
    var layer_tourism_attraction_2 = new L.geoJson(json_tourism_attraction_2, {
      attribution: '',
      interactive: true,
      dataVar: 'json_tourism_attraction_2',
      layerName: 'layer_tourism_attraction_2',
      pane: 'pane_tourism_attraction_2',
      onEachFeature: pop_tourism_attraction_2,
      pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, style_tourism_attraction_2_0(feature));
      },
    }).addTo(map);
    bounds_group.addLayer(layer_tourism_attraction_2);

    // Heatmaps (image overlays)
    map.createPane('pane_Heatmap_Tourism_3');
    map.getPane('pane_Heatmap_Tourism_3').style.zIndex = 403;
    var img_Heatmap_Tourism_3 = 'data/Heatmap_Tourism_3.png';
    var img_bounds_Heatmap_Tourism_3 = [[24.375557500000003,118.2251783],[24.539141500000003,118.4796423]];
    var layer_Heatmap_Tourism_3 = new L.imageOverlay(img_Heatmap_Tourism_3, img_bounds_Heatmap_Tourism_3, {pane: 'pane_Heatmap_Tourism_3'}).addTo(map);
    bounds_group.addLayer(layer_Heatmap_Tourism_3);

    map.createPane('pane_Heatmap_House_4');
    map.getPane('pane_Heatmap_House_4').style.zIndex = 404;
    var img_Heatmap_House_4 = 'data/Heatmap_House_4.png';
    var img_bounds_Heatmap_House_4 = [[24.374841611246783,118.27824325],[24.504415611246785,118.44283725]];
    var layer_Heatmap_House_4 = new L.imageOverlay(img_Heatmap_House_4, img_bounds_Heatmap_House_4, {pane: 'pane_Heatmap_House_4'}).addTo(map);
    bounds_group.addLayer(layer_Heatmap_House_4);

    // Search control (Photon)
    const url = {"Nominatim OSM": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
                 "France BAN": "https://api-adresse.data.gouv.fr/search/?"};
    var photonControl = L.control.photon({
      url: url["Nominatim OSM"],
      feedbackLabel: '',
      position: 'topleft',
      includePosition: true,
      initial: true,
    }).addTo(map);
    photonControl._container.childNodes[0].style.borderRadius="10px";

    var x = null; var marker = null; var z = null;
    photonControl.on('selected', function(e) {
      if (x != null) {
        if (obj3.marker) map.removeLayer(obj3.marker);
        map.removeLayer(x);
      }
      obj2.gcd = e.choice;
      x = L.geoJSON(obj2.gcd).addTo(map);
      var label = (typeof obj2.gcd.properties.label === 'undefined')
        ? obj2.gcd.properties.display_name
        : obj2.gcd.properties.label;
      obj3.marker = L.marker(x.getLayers()[0].getLatLng()).bindPopup(label).addTo(map);
      map.setView(x.getLayers()[0].getLatLng(), 17);
      z = (typeof e.choice.properties.label === 'undefined')
        ? e.choice.properties.display_name
        : e.choice.properties.label;
      e.target.input.value = z;
    });

    // Tweak search control UI
    var search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
    search.classList.add("leaflet-control-search");
    search.style.display = "flex";
    search.style.backgroundColor="rgba(255,255,255,0.5)";
    var button = document.createElement("div");
    button.id = "gcd-button-control";
    button.className = "gcd-gl-btn fa fa-search search-button";
    search.insertBefore(button, search.firstChild);
    var last = search.lastChild;
    last.style.display = "none";
    button.addEventListener("click", function () {
      last.style.display = (last.style.display === "none") ? "block" : "none";
    });

    // Layers tree (then move into sidebar)
    var overlaysTree = [
      {label: "Heatmap_House", layer: layer_Heatmap_House_4},
      {label: "Heatmap_Tourism", layer: layer_Heatmap_Tourism_3},
      {label: '<img src="legend/tourism_attraction_2.png" /> tourism_attraction', layer: layer_tourism_attraction_2},
      {label: '<img src="legend/Centroids_House_1.png" /> Centroids_House', layer: layer_Centroids_House_1},
      {label: "OpenStreetMap", layer: layer_OpenStreetMap_0},
    ];
    var lay = L.control.layers.tree(null, overlaysTree, { collapsed: false });
    lay.addTo(map);

    // Move the Layers Tree into the sidebar and expand it
    var container = document.getElementById('layersContainer');
    if (container && lay && lay._container) {
      container.appendChild(lay._container);
      lay._container.classList.add('leaflet-control-layers-expanded');
      // clear any inline heights
      var list = lay._container.querySelector('.leaflet-control-layers-list');
      if (list) list.style.height = '';
    }

    // ✨ CHANGE: Download helpers (GeoJSON)
    function saveTextAsFile(text, filename, mime = "application/json") { // ✨ CHANGE
      const blob = new Blob([text], { type: mime });                     // ✨ CHANGE
      const url = URL.createObjectURL(blob);                             // ✨ CHANGE
      const a = document.createElement("a");                             // ✨ CHANGE
      a.href = url; a.download = filename;                               // ✨ CHANGE
      document.body.appendChild(a); a.click();                           // ✨ CHANGE
      document.body.removeChild(a); URL.revokeObjectURL(url);            // ✨ CHANGE
    }                                                                     // ✨ CHANGE

    function downloadGeoJSONFromLayer(layer, filename){                   // ✨ CHANGE
      const gj = layer.toGeoJSON();                                       // ✨ CHANGE
      saveTextAsFile(JSON.stringify(gj), filename);                       // ✨ CHANGE
    }                                                                     // ✨ CHANGE

    function downloadAll_Centroids(){                                     // ✨ CHANGE
      downloadGeoJSONFromLayer(layer_Centroids_House_1, "centroids_house_all.geojson"); // ✨ CHANGE
    }                                                                     // ✨ CHANGE

    function downloadAll_Tourism(){                                       // ✨ CHANGE
      downloadGeoJSONFromLayer(layer_tourism_attraction_2, "tourism_attraction_all.geojson"); // ✨ CHANGE
    }                                                                     // ✨ CHANGE

    function downloadVisible_Both(){                                      // ✨ CHANGE
      const bounds = map.getBounds();                                     // ✨ CHANGE
      const features = [];                                                // ✨ CHANGE

      [layer_Centroids_House_1, layer_tourism_attraction_2].forEach(function(LAYER){ // ✨ CHANGE
        LAYER.eachLayer(function(lyr){                                    // ✨ CHANGE
          if (!lyr.getLatLng) return;                                     // ✨ CHANGE
          const ll = lyr.getLatLng();                                     // ✨ CHANGE
          if (bounds.contains(ll) && lyr.feature) {                       // ✨ CHANGE
            features.push(JSON.parse(JSON.stringify(lyr.feature)));       // ✨ CHANGE
          }                                                               // ✨ CHANGE
        });                                                               // ✨ CHANGE
      });                                                                 // ✨ CHANGE

      const fc = { type: "FeatureCollection", features };                 // ✨ CHANGE
      saveTextAsFile(JSON.stringify(fc), "features_in_view.geojson");     // ✨ CHANGE
    }                                                                     // ✨ CHANGE

    setBounds();
    L.ImageOverlay.include({ getBounds: function () { return this._bounds; } });
  </script>
</body>
</html>
